<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>تسجيل شركة جديدة - سهلات</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="js/storage.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/firebase.js"></script>
</head>
<body>
<header class="site-header"><div class="container"><div class="brand">سهلات</div></div></header>
<main class="container">
  <h1>تسجيل شركة جديدة</h1>
  <form id="companyForm" class="form-card">
    <div class="form-grid">
      <div class="field" style="grid-column:1/-1">
        <label for="accessCode">كود سهلات</label>
        <input id="accessCode" type="password" required pattern="^951753##$" maxlength="8" autocomplete="off" />
      </div>
  <div class="field"><label for="companyName">اسم الشركة</label><input id="companyName" required /></div>
      <div class="field">
        <label for="companyCity">المدينة</label>
        <select id="companyCity">
          <option>الرياض</option>
          <option>جدة</option>
          <option>مكة</option>
          <option>المدينة المنورة</option>
          <option>الدمام</option>
          <option>الخبر</option>
        </select>
      </div>
      <div class="field"><label for="companyPhone">رقم الجوال</label><input id="companyPhone" placeholder="05xxxxxxxx" /></div>
      <div class="field"><label for="companyEmail">البريد الإلكتروني</label><input id="companyEmail" type="email" /></div>
      <div class="field"><label for="companyPass">كلمة المرور</label><input id="companyPass" type="password" /></div>
      <div class="field" style="grid-column:1/-1">
        <label for="companyLogo">شعار/لوقو الشركة (صورة) *</label>
        <input id="companyLogo" type="file" accept="image/*" required />
        <div style="display:flex; align-items:center; gap:10px; margin-top:8px">
          <img id="logoPreview" src="company-fallback.svg" alt="شعار الشركة" style="width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb" onerror="this.src='company-fallback.svg'" />
          <div class="form-help">هذا الشعار سيظهر للباحثين ضمن قائمة الشركات</div>
        </div>
      </div>
      <div class="field" style="grid-column:1/-1">
        <label><input id="showSeekers" type="checkbox" checked /> عرض بيانات الباحثين</label>
      </div>
    </div>
    <div class="actions" style="margin-top:12px">
      <button class="btn btn--primary" type="submit">استمرار</button>
      <a class="btn" href="company-login.html">لدي حساب</a>
      <a class="btn" href="index.html">⬅️ رجوع</a>
    </div>
  </form>
</main>
<footer class="site-footer"><div class="container">© <span id="y"></span> سهلات</div></footer>
<script>
  document.getElementById('y').textContent = new Date().getFullYear();
  const logoInput = document.getElementById('companyLogo');
  const logoPreview = document.getElementById('logoPreview');
  if (logoInput){
    logoInput.addEventListener('change', ()=>{
      const f = logoInput.files && logoInput.files[0];
      if (!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{ logoPreview.src = fr.result||''; };
      fr.readAsDataURL(f);
    });
  }
  document.getElementById('companyForm').addEventListener('submit', async (e)=>{
    e.preventDefault();
  const code = document.getElementById('accessCode').value.trim();
  if (code !== '951753##'){ alert('كود سهلات غير صحيح'); return; }
    const name = document.getElementById('companyName').value.trim();
    if(!name){ alert('يرجى كتابة اسم الشركة'); return; }
    const cityEl = document.getElementById('companyCity');
    const phone = (document.getElementById('companyPhone').value||'').trim();
    const email = (document.getElementById('companyEmail').value||'').trim();
    const password = (document.getElementById('companyPass').value||'').trim();
    if (!phone && !email){ alert('يرجى إدخال رقم الجوال أو البريد الإلكتروني'); return; }
  try { SahlatStore.setItem('companyAccessOK', 'true'); } catch {}
  const companies = JSON.parse(SahlatStore.getItem('companies')||'[]');
    const norm = (s)=> (s||'').trim().toLowerCase();
    const exists = companies.some(c=> (phone && norm(c.phone)===norm(phone)) || (email && norm(c.email)===norm(email)) );
    if (exists){ alert('هذا الرقم أو البريد مسجّل مسبقاً'); return; }
    // Require logo and convert to data URL
    const file = logoInput && logoInput.files && logoInput.files[0];
    if (!file){ alert('الرجاء رفع شعار/لوقو للشركة'); return; }
    const logoDataUrl = await new Promise((res)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result||''); fr.readAsDataURL(file); });
    const company = { name, city: cityEl ? cityEl.value : '', phone, email, password, logo: logoDataUrl };
    try{
      let id = '';
      if (window.SahlatDB && SahlatDB.upsertCompany){
        try{ id = await SahlatDB.upsertCompany(company); }catch(e){ /* offline fallback */ }
      }
      if (!id){
        const makeId = (keyStr) => { let h=0; for(const ch of (keyStr||'')){ h=((h<<5)-h)+ch.charCodeAt(0); h|=0;} return 'c'+Math.abs(h); };
        id = makeId((company.email||'')+'|'+(company.phone||'')+'|'+company.name);
      }
      company.id = id;
      // backup
      const idx = companies.findIndex(c=> c && c.id===id);
      if (idx>=0) companies[idx]=company; else companies.push(company);
      SahlatStore.setItem('companies', JSON.stringify(companies));
      SahlatStore.setItem('currentCompany', JSON.stringify(company));
    } catch {}
    window.location.href = 'company-home.html';
  });
</script>
</body>
</html>
