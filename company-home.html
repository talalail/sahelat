<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±ÙƒØ© - Ø³Ù‡Ù„Ø§Øª</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <script src="js/storage.js"></script>
  <script src="js/firebase-config.js"></script>
  <script src="js/firebase.js"></script>
  <style>
    .filters{display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr; gap:10px}
    @media (max-width: 900px){.filters{grid-template-columns:1fr 1fr}}
    @media (max-width: 560px){.filters{grid-template-columns:1fr}}
    /* Rotating subtitle text (light, subtle) */
  #rotatingText{display:inline-block; opacity:0; transform:translateY(6px); transition: opacity .35s ease, transform .35s ease; color:#334155; font-size:16px}
    #rotatingText.show{opacity:1; transform:translateY(0)}
  /* Nudge the main yellow card a bit lower under the header */
  .company-head{margin-top:12px}
    /* Company header: move logo to the left side */
    .company-head .avatar-pin{right:auto; left:8px; top:6px}
    .company-head .profile-head__info{padding-inline-end:12px; padding-inline-start:120px; text-align:right}
    .company-head h1{font-size:22px !important; margin:2px 0 4px !important}
    .company-head .profile-head__info .form-help{font-size:15px}
    @media (max-width: 560px){
      .company-head .profile-head__info{padding-inline-start:0}
    }
      /* Light toggle button styling */
      .toggle-btn{background:#f8fafc; color:#0b1222; border:1px solid #e2e8f0}
      .toggle-btn:hover{background:#eef2f7}
      .toggle-btn.is-active{background:#fffbe6; border-color:#facc15; color:#7a5c00}
  </style>
</head>
<body class="center-header">
<header class="site-header">
  <div class="container">
    <div class="header-stack" style="display:flex; flex-direction:column; align-items:center; gap:6px">
      <div class="brand">Ø³Ù‡Ù„Ø§Øª</div>
      <div class="form-help" style="margin:6px 0 0 0">
        <span id="rotatingText" class="show">ØºØ·Ù‘Ù Ø§Ù„Ù…ÙƒØ§Ù† Ù‚Ø¨Ù„ Ù„Ø§ ÙŠÙˆÙ‚Ù Ø§Ù„Ø´ØºÙ„.</span>
      </div>
    </div>
  </div>
</header>
<main class="container">
  <section class="yellow-card company-head">
    <div class="profile-head" style="margin-bottom:12px">
  <img class="avatar-pin" src="search-employee.svg" alt="Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù" />
      <div class="profile-head__info">
  <h1 style="margin:6px 0 6px; font-size:20px; color:#0b1222">Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ù†Ø§Ø³Ø¨</h1>
        <div class="form-help" style="color:#334155">Ø§Ø¨Ø­Ø« ÙˆÙÙ„ØªØ± Ø§Ù„Ø¨Ø§Ø­Ø«ÙŠÙ† Ø¨Ø­Ø³Ø¨ Ø§Ù„ÙˆØ¸ÙŠÙØ© ÙˆØ§Ù„Ù…Ø¯ÙŠÙ†Ø© ÙˆØ§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„Ø¬Ù†Ø³ÙŠØ©</div>
        <div class="actions" style="margin-top:6px; gap:8px">
          <button id="browseSeekersBtn" class="btn toggle-btn" type="button" style="padding:6px 10px">Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø­Ø«ÙŠÙ†</button>
          <button id="shareCompanyBtn" class="btn" type="button" style="padding:6px 10px">ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø´Ø±ÙƒØ©</button>
        </div>
      </div>
    </div>
    <div id="filtersBox" class="filters" style="display:none">
      <select id="fJob">
        <option value="">Ø§Ù„ÙˆØ¸ÙŠÙØ©</option>
        <option>ÙƒØ§Ø´ÙŠØ±</option>
        <option>Ù…Ø­Ø§Ø³Ø¨</option>
        <option>Ø¨Ø§Ø¦Ø¹</option>
        <option>Ø³ÙƒØ±ØªÙŠØ±</option>
        <option>Ø®Ø¯Ù…Ø© Ø¹Ù…Ù„Ø§Ø¡</option>
        <option>Ø­Ø§Ø±Ø³ Ø£Ù…Ù†</option>
        <option>Ù†Ø§Ø¯Ù„</option>
        <option>Ø£ÙŠÙ‘Ù‡Ù…Ø§ Ø£Ø³Ø¨Ù‚</option>
      </select>
      <select id="fCity">
        <option value="">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
        <option>Ø§Ù„Ø±ÙŠØ§Ø¶</option>
        <option>Ø¬Ø¯Ø©</option>
        <option>Ù…ÙƒØ©</option>
        <option>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
        <option>Ø§Ù„Ø¯Ù…Ø§Ù…</option>
        <option>Ø§Ù„Ø®Ø¨Ø±</option>
        <option>Ø¨Ø±ÙŠØ¯Ø©</option>
        <option>ØªØ¨ÙˆÙƒ</option>
        <option>Ø£Ø¨Ù‡Ø§</option>
        <option>Ø¬Ø§Ø²Ø§Ù†</option>
      </select>
      <input id="minAge" inputmode="numeric" maxlength="2" placeholder="Ø¹Ù…Ø± Ù…Ù†" />
      <input id="maxAge" inputmode="numeric" maxlength="2" placeholder="Ø¹Ù…Ø± Ø¥Ù„Ù‰" />
    </div>
  </section>

  <section style="margin-top:14px">
  <div id="resultsMeta" class="actions" style="display:none; justify-content:space-between; align-items:center; margin-bottom:8px">
      <div class="form-help" id="resultsCount">Ø§Ù„Ù†ØªØ§Ø¦Ø¬: 0</div>
      <button id="clearFilters" class="btn btn--secondary" type="button">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
    </div>
    <!-- Company info editor -->
    <div id="companyInfoCard" class="form-card" style="margin-bottom:12px">
      <h3 style="margin:0 0 10px">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© / Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</h3>
      <div class="form-grid">
        <div class="field"><label for="cName">Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©</label><input id="cName" required /></div>
        <div class="field">
          <label for="cCity">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</label>
          <select id="cCity">
            <option value="">â€”</option>
            <option>Ø§Ù„Ø±ÙŠØ§Ø¶</option>
            <option>Ø¬Ø¯Ø©</option>
            <option>Ù…ÙƒØ©</option>
            <option>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©</option>
            <option>Ø§Ù„Ø¯Ù…Ø§Ù…</option>
            <option>Ø§Ù„Ø®Ø¨Ø±</option>
            <option>Ø¨Ø±ÙŠØ¯Ø©</option>
            <option>ØªØ¨ÙˆÙƒ</option>
            <option>Ø£Ø¨Ù‡Ø§</option>
            <option>Ø¬Ø§Ø²Ø§Ù†</option>
          </select>
        </div>
        <div class="field"><label for="cPhone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label><input id="cPhone" placeholder="05xxxxxxxx" /></div>
        <div class="field"><label for="cEmail">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input id="cEmail" type="email" /></div>
        <div class="field"><label for="cPass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="cPass" type="password" /></div>
        <div class="field" style="grid-column:1/-1">
          <label for="cLogo">Ø§Ù„Ø´Ø¹Ø§Ø± / Ø§Ù„Ù„ÙˆÙ‚Ùˆ (ØµÙˆØ±Ø©)</label>
          <input id="cLogo" type="file" accept="image/*" />
          <div style="display:flex; align-items:center; gap:10px; margin-top:8px">
            <img id="cLogoPreview" src="company-fallback.svg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" style="width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid #e5e7eb" onerror="this.src='company-fallback.svg'" />
            <div class="form-help">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø´Ø¹Ø§Ø± ÙˆØ§Ø¶Ø­. Ù‡Ø°Ø§ Ø§Ù„Ø´Ø¹Ø§Ø± Ø³ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¨Ø§Ø­Ø«ÙŠÙ† Ø¹Ù† Ø§Ù„ÙˆØ¸Ø§Ø¦Ù.</div>
          </div>
        </div>
      </div>
      <div class="actions" style="margin-top:12px">
        <button id="saveCompanyBtn" class="btn btn--primary" type="button">Ø­ÙØ¸</button>
        <button id="cancelCompanyBtn" class="btn" type="button">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  <div id="results" class="form-card" style="display:none"></div>
  </section>
</main>
<footer class="site-footer"><div class="container">Â© <span id="y"></span> Ø³Ù‡Ù„Ø§Øª Â· <a class="btn" href="sync.html" style="padding:6px 10px">Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a></div></footer>
<script>
  document.getElementById('y').textContent = new Date().getFullYear();
  // Gate access: require prior company access approval
  try{
    const ok = (SahlatStore.getItem('companyAccessOK') === 'true');
    if (!ok){
      alert('Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø´Ø±ÙƒØ§Øª ÙŠØªØ·Ù„Ø¨ Ø±Ù…Ø² Ø¯Ø®ÙˆÙ„. Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.');
      window.location.href = 'company-login.html';
    }
  }catch{}
  // Rotating short phrases under the brand in header (companies page)
  (function(){
    const phrases = [
      'ØºØ·Ù‘Ù Ø§Ù„Ù…ÙƒØ§Ù† Ù‚Ø¨Ù„ Ù„Ø§ ÙŠÙˆÙ‚Ù Ø§Ù„Ø´ØºÙ„.',
      'Ù„Ø§ ØªØ¶ÙŠØ¹ Ø§Ù„ÙˆÙ‚Øªâ€¦ Ù„Ù‚Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù„ÙŠ ÙŠÙ†Ø§Ø³Ø¨Ùƒ Ø§Ù„Ø¢Ù†.',
      'Ø®Ø° Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ØŒ ÙˆØ®Ù„ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ ÙŠØ´ØªØºÙ„ Ø¨Ø«Ù‚Ø©.',
      'ÙƒÙ„ ÙˆØ¸ÙŠÙØ© ÙØ§Ø¶ÙŠØ© = ÙØ±ØµØ© Ù„Ø´Ø®Øµ Ø¬Ø§Ù‡Ø².',
      'Ø¯ÙˆØ± Ø¨Ø³Ø±Ø¹Ø©ØŒ ØºØ·Ù‘ Ø¨Ø³Ø±Ø¹Ø©.',
      'Ø´ØºÙ„Ùƒ ÙŠØ­ØªØ§Ø¬ Ø´Ø®Øµ Ù…Ø«Ù„Ù‡ØŸ Ù„Ù‚Ø§Ù‡ ÙÙŠ Ø³Ù‡Ù„Ø§Øª.',
      'Ù„Ø§ ØªØ®Ù„ÙŠ Ø§Ù„Ø´Ø§ØºØ± ÙŠØ·ÙˆÙ‘Ù„â€¦ Ø­Ù„Ù‘Ù‡ ÙÙŠ Ø¯Ù‚Ø§Ø¦Ù‚.',
      'Ø§Ø®ØªØµØ± Ø§Ù„Ù…Ø´ÙˆØ§Ø±ØŒ ÙˆÙ„Ù‚Ù Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ù„ÙŠ ÙŠÙƒÙ…Ù„ ÙØ±ÙŠÙ‚Ùƒ.',
      'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ù‚ÙˆÙŠ ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø°ÙƒÙŠ.',
      'Ø´ÙˆÙ Ù…Ù† Ø§Ù„Ø¬Ø§Ù‡Ø² Ø§Ù„ÙŠÙˆÙ…ØŒ ÙˆØ§Ø¨Ø¯Ø£ Ø¨ÙƒØ±Ø©.',
      'ØºØ·Ù‘ Ø§Ù„ÙØ¬ÙˆØ© Ù‚Ø¨Ù„ Ù…Ø§ ØªÙƒØ¨Ø±.',
      'Ø®Ù„Ù‘ Ø§Ù„ÙƒÙØ§Ø¡Ø© ØªÙˆØµÙ„ Ù„Ùƒ Ø¨Ø¯Ù„ Ù…Ø§ ØªØ¯ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§.',
      'Ø§Ù„Ø´Ø®Øµ Ø§Ù„ØµØ­ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„ØµØ­ = Ø¥Ù†Ø¬Ø§Ø² Ø£Ø³Ø±Ø¹.',
      'Ù„Ù‚Ù Ù…ÙˆØ¸ÙÙƒ Ø§Ù„Ø¬Ø§ÙŠ ÙÙŠ Ø¶ØºØ·Ø© Ø²Ø±.',
      'Ù„Ø§ ØªÙ†ØªØ¸Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ†ØŒ Ø´ÙˆÙÙ‡Ù… Ø¨Ù†ÙØ³Ùƒ.',
      'ØºØ·Ù‘ Ù†Ù‚ØµÙƒ Ø¨ÙƒÙØ§Ø¡Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ÙŠÙˆÙ….',
      'Ø®Ù„Ùƒ Ø£ÙˆÙ„ Ù…Ù† ÙŠÙƒØªØ´Ù Ø§Ù„Ù…ÙˆØ§Ù‡Ø¨ Ø§Ù„Ø¬Ø§Ù‡Ø²Ø©.',
      'ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© ØªØ£Ø®ÙŠØ± Ù…Ù…ÙƒÙ† ØªÙƒÙ„Ù‘ÙÙƒ Ø¥Ù†ØªØ§Ø¬.',
      'Ù„Ø§ ØªÙÙƒØ± ÙƒØ«ÙŠØ±â€¦ Ø³Ù‡Ù‘Ù„Ù‡Ø§ØŒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„ØªÙˆØ¸ÙŠÙ.',
      'Ø§ÙƒØªØ´ÙØŒ Ø§Ø®ØªØ§Ø±ØŒ ØºØ·Ù‘ÙŠ â€” Ø¨Ø®Ø·ÙˆØ§Øª Ø³Ù‡Ù„Ø§Øª.'
    ];
    const rot = document.getElementById('rotatingText');
    if(!rot) return;
    let i = 0;
    function cycle(){
      rot.classList.remove('show');
      setTimeout(()=>{
        rot.textContent = phrases[i % phrases.length];
        i++;
        rot.classList.add('show');
      }, 220);
    }
    setTimeout(()=>rot.classList.add('show'), 60);
  setInterval(cycle, 6000);
  })();
  const results = document.getElementById('results');
  const metaBox = document.getElementById('resultsMeta');
  const filtersBox = document.getElementById('filtersBox');
  const section = metaBox ? metaBox.parentNode : null;
  const els = {
    q: document.getElementById('q'),
    job: document.getElementById('fJob'),
    city: document.getElementById('fCity'),
    minAge: document.getElementById('minAge'),
    maxAge: document.getElementById('maxAge')
  };
  const digits = (s)=> (s||'').replace(/[^0-9]/g,'');
  const countEl = document.getElementById('resultsCount');
  const clearBtn = document.getElementById('clearFilters');
  function clearFilters(){
    if (els.q) els.q.value=''; els.job.value=''; els.city.value=''; els.minAge.value=''; els.maxAge.value='';
    apply();
  }
  clearBtn.addEventListener('click', clearFilters);
  function render(list){
    if (!list || !list.length){ results.innerHTML = '<div class="form-help">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>'; return; }
    results.innerHTML = '';
    for(const s of list){
      const card = document.createElement('div'); card.className='card';
      const img = document.createElement('img'); img.className='avatar'; img.src = s.photoUrl || 'jobseeker.jpg'; img.onerror = ()=>{ img.src='jobseeker-fallback.svg' };
      const box = document.createElement('div');
      const name = document.createElement('div'); name.style.fontWeight='800'; name.textContent = s.fullName || '';
      const help = document.createElement('div'); help.className='form-help';
      const bits=[]; if(s.city) bits.push(s.city); if(s.age) bits.push(s.age+' Ø³Ù†Ø©'); if(s.nationality) bits.push(s.nationality);
      help.textContent = bits.join(' â€¢ ');
      const jobs = document.createElement('div');
      if (Array.isArray(s.jobs)){
        for(const j of s.jobs){ const span=document.createElement('span'); span.className='chip-gray'; span.textContent=j; jobs.appendChild(span); }
      }
      const actions = document.createElement('div'); actions.className='actions'; actions.style.marginTop='8px';
      const view = document.createElement('a'); view.className='btn btn--primary'; view.textContent='Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù'; view.href='seeker-view.html?id=' + encodeURIComponent(s.id||'');
      actions.appendChild(view);
      box.append(name, help, jobs, actions);
      card.append(img, box); results.appendChild(card);
    }
  }
  let LIVE_SEEKERS = [];
  function apply(){
    // prefer live data if available
    let arr = (Array.isArray(LIVE_SEEKERS) && LIVE_SEEKERS.length) ? LIVE_SEEKERS.slice() : [];
    if (!arr.length){ try{ arr = JSON.parse(SahlatStore.getItem('seekers')||'[]'); }catch{} }
    // Ensure each seeker has an id (for older saved data)
    const makeId = (keyStr) => { let h=0; for(const ch of (keyStr||'')){ h=((h<<5)-h)+ch.charCodeAt(0); h|=0;} return 's'+Math.abs(h); };
    let mutated = false;
    for (const s of arr){
      if (!s.id){ const key = s.email || s.phone || s.nationalId || s.fullName || Math.random().toString(36).slice(2); s.id = makeId(key); mutated = true; }
    }
    // If no seekers found, seed from active seekerProfile (registered before upsert logic)
    if (!arr.length){
      try{
        const p = JSON.parse(localStorage.getItem('seekerProfile')||'{}');
        if (p && (p.fullName || p.email || p.phone || p.nationalId)){
          const key = p.email || p.phone || p.nationalId || p.fullName;
          p.id = p.id || makeId(key);
          arr = [p];
          mutated = true;
        }
      }catch{}
    }
    if (mutated){ try{ localStorage.setItem('seekers', JSON.stringify(arr)); }catch{} }
  const q = els.q ? (els.q.value||'').trim() : '';
    const job = els.job.value||''; const city = els.city.value||'';
    const min = parseInt(digits(els.minAge.value)||'-1',10); const max = parseInt(digits(els.maxAge.value)||'999',10);
    const out = arr.filter(s=>{
      // text query over name/city/nationality
      if (q){ const txt=(s.fullName+' '+(s.city||'')+' '+(s.nationality||'')).toLowerCase(); if(!txt.includes(q.toLowerCase())) return false; }
      if (job){ if (!Array.isArray(s.jobs) || !s.jobs.includes(job)) return false; }
      if (city){ if (s.city!==city) return false; }
      const ageNum = parseInt((s.age||'').replace(/[^0-9]/g,''),10);
      if (!isNaN(min) && ageNum < min) return false;
      if (!isNaN(max) && ageNum > max) return false;
      return true;
    });
    // Update count and clear button state
    if (countEl) countEl.textContent = `Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${out.length}`;
    const filtersActive = q || job || city || (els.minAge.value||'') || (els.maxAge.value||'');
    if (clearBtn) clearBtn.disabled = !filtersActive;
    render(out);
  }
  if (els.q) els.q.addEventListener('input', apply);
  els.job.addEventListener('change', apply);
  els.city.addEventListener('change', apply);
  els.minAge.addEventListener('input', apply);
  els.maxAge.addEventListener('input', apply);
  apply();

  // Live Firestore subscription (job_seekers)
  (function(){
    if (!window.SahlatDB) return;
    SahlatDB.subscribeSeekers(function(all){
      LIVE_SEEKERS = Array.isArray(all) ? all : [];
      try{ SahlatStore.setItem('seekers', JSON.stringify(LIVE_SEEKERS)); }catch{}
      if (seekersVisible){ apply(); }
    });
  })();

  // My Info editor logic
  const myBtn = document.getElementById('myInfoBtn');
  const card = document.getElementById('companyInfoCard');
  const cName = document.getElementById('cName');
  const cCity = document.getElementById('cCity');
  const cPhone = document.getElementById('cPhone');
  const cEmail = document.getElementById('cEmail');
  const cPass = document.getElementById('cPass');
  const cLogo = document.getElementById('cLogo');
  const cLogoPreview = document.getElementById('cLogoPreview');
  const saveBtn = document.getElementById('saveCompanyBtn');
  const cancelBtn = document.getElementById('cancelCompanyBtn');

  function makeId(key){ let h=0; for(const ch of (key||'')){ h=((h<<5)-h)+ch.charCodeAt(0); h|=0;} return 'c'+Math.abs(h); }
  function getCompanies(){ try{ return JSON.parse(SahlatStore.getItem('companies')||'[]') }catch{ return [] } }
  function setCompanies(arr){ try{ SahlatStore.setItem('companies', JSON.stringify(arr)); }catch{} }
  function getCurrentCompany(){
    try{
      const cur = JSON.parse(SahlatStore.getItem('currentCompany')||'null');
      if (cur && cur.name) return cur;
      const arr = getCompanies();
      return arr.length ? arr[arr.length-1] : null;
    }catch{ return null }
  }
  function setCurrentCompany(obj){ try{ SahlatStore.setItem('currentCompany', JSON.stringify(obj)); }catch{} }

  function openEditor(){
    const data = getCurrentCompany() || {};
    cName.value = data.name || '';
    cCity.value = data.city || '';
    cPhone.value = data.phone || '';
    cEmail.value = data.email || '';
    cPass.value = data.password || '';
    cLogoPreview.src = data.logo || 'company-fallback.svg';
    card.style.display = '';
    card.scrollIntoView({behavior:'smooth', block:'center'});
  }
  function closeEditor(){ card.style.display='none'; }

  if (myBtn){ myBtn.addEventListener('click', openEditor); }
  if (cancelBtn){ cancelBtn.addEventListener('click', closeEditor); }
  if (cLogo){
    cLogo.addEventListener('change', ()=>{
      const f = cLogo.files && cLogo.files[0];
      if (!f) return;
      const fr = new FileReader();
      fr.onload = ()=>{ cLogoPreview.src = fr.result||''; };
      fr.readAsDataURL(f);
    });
  }

  async function toDataUrl(file){
    return await new Promise((res)=>{ const fr = new FileReader(); fr.onload=()=>res(fr.result||''); fr.readAsDataURL(file); });
  }

  if (saveBtn){
    saveBtn.addEventListener('click', async ()=>{
      const name = (cName.value||'').trim();
      if (!name){ alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ø´Ø±ÙƒØ©'); return; }
      const phoneVal = (cPhone.value||'').trim();
      const emailVal = (cEmail.value||'').trim();
      if (!phoneVal && !emailVal){ alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ'); return; }
      const existing = getCurrentCompany() || {};
      let logo = existing.logo || '';
      const file = cLogo.files && cLogo.files[0];
      if (file){ logo = await toDataUrl(file); }
      if (!logo){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ø´Ø¹Ø§Ø±/Ù„ÙˆÙ‚Ùˆ Ù„Ù„Ø´Ø±ÙƒØ©'); return; }
      const obj = {
        id: existing.id || makeId((existing.email||'') + '|' + (existing.phone||'') + '|' + (existing.name||name) + '|' + Date.now()),
        name,
        city: (cCity.value||'').trim(),
        phone: phoneVal,
        email: emailVal,
        password: (cPass.value||'').trim(),
        logo
      };
      // upsert into companies list
      const arr = getCompanies();
      // enforce uniqueness for phone/email across others
      const norm = (s)=> (s||'').trim().toLowerCase();
      const dupe = arr.find(x=> x && x.id !== obj.id && ((phoneVal && norm(x.phone)===norm(phoneVal)) || (emailVal && norm(x.email)===norm(emailVal))));
      if (dupe){ alert('Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù‘Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù„Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø±'); return; }
      // Upsert to Firestore first
      try{
        if (!window.SahlatDB){ throw new Error('no-db'); }
        const newId = await SahlatDB.upsertCompany(obj);
        obj.id = newId;
      }catch(e){ /* keep local */ }
      const idx = obj.id ? arr.findIndex(x=>x && x.id===obj.id) : -1;
      if (idx >= 0){ arr[idx] = obj; }
      else {
        const i2 = arr.findIndex(x=>x && x.name===existing.name);
        if (i2>=0) arr[i2]=obj; else arr.push(obj);
      }
      setCompanies(arr);
      setCurrentCompany(obj);
      alert('ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©');
      // keep info visible by default
      // no need to refresh companies grid here; seekers will see updated logo from localStorage
    });
  }

  // Ensure info is visible and prefilled on load
  openEditor();

  // Toggle seekers browser
  const browseBtn = document.getElementById('browseSeekersBtn');
  let seekersVisible = false;
  function setSeekersVisible(v){
    seekersVisible = v;
    if (filtersBox) filtersBox.style.display = v ? 'grid' : 'none';
    if (metaBox) metaBox.style.display = v ? 'flex' : 'none';
    if (results) results.style.display = v ? '' : 'none';
    if (browseBtn) browseBtn.textContent = v ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¨Ø§Ø­Ø«ÙŠÙ†' : 'Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø­Ø«ÙŠÙ†';
    if (browseBtn) browseBtn.classList.toggle('is-active', !!v);
    // Move and show/hide company info card as requested
    if (section && card){
      if (v){
        // move card to the bottom and hide it
        section.appendChild(card);
        card.style.display = 'none';
      } else {
        // restore card before results and show it
        try{ section.insertBefore(card, results); }catch{}
        card.style.display = '';
        card.scrollIntoView({behavior:'smooth', block:'start'});
      }
    }
    if (v) apply();
  }
  if (browseBtn){ browseBtn.addEventListener('click', ()=> setSeekersVisible(!seekersVisible)); }

  // Share company: builds import link to copy/share cross-device
  (function(){
    var btn = document.getElementById('shareCompanyBtn');
    if (!btn) return;
    btn.addEventListener('click', async function(){
      try{
        var cur = getCurrentCompany();
        if (!cur || !cur.name){ alert('ÙŠØ±Ø¬Ù‰ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ© Ø£ÙˆÙ„Ø§Ù‹'); return; }
        var payload = { company: cur };
        var txt = JSON.stringify(payload);
        var enc = encodeURIComponent(txt);
        var base = location.origin + location.pathname.replace(/[^/]*$/, '');
        var url = base + 'import.html?data=' + enc;
        if (navigator.share){ await navigator.share({ url, title: 'Ù…Ø´Ø§Ø±ÙƒØ© Ø´Ø±ÙƒØ© Ø³Ù‡Ù„Ø§Øª' }); }
        else if (navigator.clipboard){ await navigator.clipboard.writeText(url); alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©. Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø¢Ø®Ø± Ù„ÙØªØ­ ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø³Ø±ÙŠØ¹.'); }
        else { prompt('Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', url); }
      }catch(e){ alert('ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©'); }
    });
  })();
</script>
</body>
</html>
